elon.include("echelon/Cache");Echelon.LoggerCache=function(W){Echelon.TimeDependentDataCacheObject.call(this,W);if(W.requestDpCfgs){Echelon.NvCacheObject.call(this,W)}this.clearLog=function(ae,ad){var ag=ae?'[UCPTlastUpdate>="'+ae.toFormattedString(elon.DateTimeObject.isoMsFormat)+'"]':"";var af=ad?'[UCPTlastUpdate<="'+ad.toFormattedString(elon.DateTimeObject.isoMsFormat)+'"]':"";e.Clear({Item:g.r_loggerName||g.r_loggerColl.Item,callback:function(){},xSelect:"//Item"+ag+af+t});g.clearCache()};var m=function(ae,ad){return"["+g.m_timeNode+ae+'"'+elon.DateTimeObject.getInstance(ad).toFormattedString(elon.DateTimeObject.isoMsFormat)+'"]'};var T=function(aj,ai){V=ai;var ad=null;var ah=aj||false;var ag=aj?m("<=",aj):"";ab=null;var af=">";if(!aj&&U.length>0){ab=U[U.length-1][1]}if(g.argObj.aggressiveCleaning&&g.r_activeRangeStart){if(!ab||ab<g.r_activeRangeStart){ab=g.r_activeRangeStart}af+="="}var ae=ab?m(af,ab):"";d=true;e.Read({Item:g.r_loggerName||g.r_loggerColl.Item,callback:g.m_ReadHandler(g,ah),unmanaged:true,xSelect:"//Item"+ag+ae+"[position()>=last()-"+ai+'][@xsi:type="'+q+'_Data"]'+t})};this.p_setActiveRangeInit=function(){g.f_maxPoints=g.r_initialMaxPoints;g.f_activeRangeCachedCompletely=false};this.p_activeRangeChangedSubstantially=function(ad){if(!f){if(g.minDeltaTime){g.f_setMinDeltaTime(0)}}else{if(g.minDeltaTime){g.f_setMinDeltaTime(u.getOptimalTimeInterval(ad,s))}}};this.f_desiredNumberOfSupportingPoints=function(){var ad=Math.round(g.f_maxPoints/(g.newDisplayList.length||1));ad=Math.max(3,ad);return ad};var x=function(af,ae,ad){if(af==null||g.r_dead){return true}return false};var r=function(af,ae,ad){if(I(af,ae,ad)){aa()}};var I=function(an,ai,ah,ae){var ag=false;if(!elon.util.isAlive(g.parentView.domObj)){g.clearCallbacks();return ag}if(x(an,ai,ah)){return ag}var ap,ax,ak;var ao=false;if(an.r_proxy_type==q+"_Meta_Data"){var aj=e.getItem({type:"Item_DataColl"});aj.Item.push(an);an=aj}else{if(!an.Item||!an.Item.length){return ag}}g.f_isLiveLog=g.r_timeRangeDp&&(g.r_timeRangeDp.to.getTime()==g.stopTime);if(an.Item&&an.Item.length>0){for(var at=0;at<an.Item.length;at++){if((an.Item[at].fault.faultcode!=null)&&!g.argObj.noErrMsg){j.setErrMsg(an.Item[at].fault.faultstring.get());an.Item.remove(at--);continue}if(an.Item[at].r_proxy_type==q+"_Meta_Data"){var ar=an.Item.remove(at--);var au=ar.UCPTname.get();if(g.r_loggerColl.Item.length>1){var av=false;for(var aq=0;aq<g.r_loggerColl.Item.length;aq++){if(g.r_loggerColl.Item[aq].UCPTname.get()==au){av=true;break}}if(!av){continue}}h[au]=ar.UCPTtotalCount.get();if(ar.UCPTtotalCount.get()>0){if(ap==null||ap>ar.UCPTstart.getTime()){ap=ar.UCPTstart.getTime()}if(ax==null||ax<ar.UCPTstop.getTime()){ax=ar.UCPTstop.getTime()}}var aw=ar.UCPTmodificationNumber.get();if(H[au]==null){H[au]=aw;N[au]=aw}if(aw>N[au]||aw<H[au]){ao=true;H[au]=null}if(g.r_loggerName!=null){break}}}var al=true;for(var ay in h){if(h[ay]>0){al=false;break}}if(al){g.f_resetRange();g.clearCache()}}var am=false;if((g.startTime==null&&ap==null)||(g.stopTime==null&&ax==null)){if(!g.argObj.noErrMsg){j.setInfMsg(n("LOG_EMPTY"))}g.clearCache()}else{if(Echelon.msgbar&&!g.argObj.noErrMsg){Echelon.msgbar.clear()}if(g.argObj.activeRangeStart=="min"&&ap){g.r_activeRangeStart=ap}if(g.argObj.activeRangeStop=="max"&&ap&&ax&&!this.m_explicitStop){g.r_activeRangeStop=ax;if(!g.r_activeRangeStart){g.r_activeRangeStart=g.r_activeRangeStop}g.f_isLiveLog=true;if(ax>g.stopTime){g.f_activeRangeCachedCompletely=false}}am=g.startTime==null||g.startTime>ap||ax>g.stopTime}if(ao||am){if(ao){g.clearCache(false);g.f_clearCollectionSuspended=true}else{if(g.startTime!=null&&g.f_isLiveLog&&ae){l=Math.max(4,l/2)}}if(ap!=null&&ax!=null){var ad=(g.startTime==null||g.startTime>ap)?ap:g.startTime;var af=Math.max(g.stopTime,ax);g.setRange(ad,af)}ag=true}else{if(g.f_isLiveLog&&ae){l=Math.min(S,l*2)}}return ag};this.m_ReadHandler=elon.Class({constructor:["parent","m_lastSoapTimeData"],closure:function(ah,ae,ad){var ag=this.parent;if(!elon.util.isAlive(ag.parentView.domObj)){return ag.clearCallbacks()}d=false;if(!x(ah,ae,ad)){I(ah,ae,ad,true);var ai=this.m_lastSoapTimeData||ag.stopTime;var af;if(ah.Item.length<V){af=ab?Math.min(ab,ag.stopTime):ag.startTime}else{af=ag.getTimeMs(ah.Item[0])+1-ag.minDeltaTime}if(ah.Item.length>0){ag.insert(ah.Item,true)}z(af,ai);if(ah.Item.length==V||(!Y)){G(ai-af)}Y=true}aa()}});var G=function(ad){if(ad!=null){k=ad}p()};var p=function(){if(R!=null&&k!=null){u.fireQuickCallback(R,null,k)}};this.onDensityChanged=function(ad){if(R!=ad){R=ad;p()}};this.reset=function(){Y=false;g.p_reset();T(null,l)};this.p_onNewDataInRangeFinalize=function(){if(Y){aa()}};this.f_trimCache=function(){if(!g.f_isLiveLog){g.clearCache();return}var ae=g.f_TimeDependentDataCacheObject_trimCache();for(var ad=0;ad<U.length;ad++){if(U[ad][0]>ae){break}if(U[ad][1]<=ae){U.splice(ad--,1);continue}U[ad][0]=ae+1}};var z=function(ae,ag){if(!u.isSafe(ae)||!u.isSafe(ag)){return}if(ag>g.stopTime){ag=g.stopTime}if(ae<g.startTime){ae=g.startTime}var af=false;for(var ad=0;(ad<U.length&&af==false);ad++){if(ae<=U[ad][0]){U.splice(ad,0,[ae,ag]);af=true}}if(!af){U.push([ae,ag])}if((ae>=g.r_activeRangeStart&&ae<=g.r_activeRangeStop)||(ag>=g.r_activeRangeStart&&ag<=g.r_activeRangeStop)){g.newDataInRange()}if(U.length>1){for(var ad=1;ad<U.length;ad++){if(U[ad][0]<=(U[ad-1][1]+1)){U[ad-1][1]=Math.max(U[ad][1],U[ad-1][1]);U.splice(ad--,1)}}}ac()};this.f_getChunk=function(ae){for(var ad=0;ad<U.length;ad++){if(ae>=U[ad][0]&&ae<=U[ad][1]){return U[ad]}}};this.onInitialized=function(ad){if(y!=ad){y=ad;if(y!=null&&Y){y()}}};this.p_handleDP_ConfigColl=function(ad){if(ad!=null&&ad.Item.length>0){g.handleAoDP_Config(ad.Item)}};this.onCacheChanged=function(ad){if(D!=ad){D=ad;if(ad!=null&&g.startTime!=null&&U.length){ac()}}};this.f_setMinDeltaTime=function(ad){if(g.r_randomSampleMode){g.minDeltaTime=ad;if(ad==0){X=S;U=new Array();f=true;g.r_overflowDp.value.set(false)}else{f=false;X=Math.min(g.m_numberOfLoggedDPs,100);g.r_overflowDp.value.set(true)}}};var ac=function(){if(D!=null){u.fireQuickCallback(D,null,U)}};var aa=function(ah,af){if(d||g.r_dead){return false}if((!g.r_randomSampleMode&&g.r_overflowDp.value.get())||g.r_activeRangeStart==null||g.r_activeRangeStop==null||g.startTime==null||g.stopTime==null){return false}if(!g.f_activeRangeCachedCompletely){var ag=false;var ae=false;for(var ad=0;ad<U.length;ad++){if(g.r_activeRangeStop>=U[ad][0]&&g.r_activeRangeStop<=U[ad][1]){ag=true;if(g.r_activeRangeStart>=U[ad][0]){g.f_activeRangeCachedCompletely=true;if(this.m_explicitStop){M(false)}}else{T(U[ad][0]-1,X);return true}}}if(!ag){if(g.f_isLiveLog){T(null,l)}else{T(g.r_activeRangeStop,X)}return true}}if(g.f_clearCollectionSuspended){g.clearCollection()}return false};this.ignoreModification=function(ad){if(N[ad]!=null){N[ad]++}};this.p_cacheCleanupFinalize=function(){if(g.getCacheSize()==0){U.length=0;ac();if(Y){aa()}g.f_activeRangeCachedCompletely=false}else{for(var ad=0;ad<U.length;ad++){if(U[ad][1]<g.startTime){U.splice(ad--,1)}else{if(U[ad][0]<g.startTime){U[ad][0]=g.startTime}}}}};this.init=function(ad){Y=false;g.r_loggerName=null;if(ad.Item&&ad.Item.length){a(ad)}else{if(ad.r_proxy_type){if(ad.r_proxy_type=="Item"){Q(ad)}else{w(ad)}}else{O(ad)}}g.r_loggerName=g.r_loggerName||((g.r_loggerColl.Item.length==1)?g.r_loggerColl.Item[0]:null);g.startReading()};var O=function(ad){g.m_elonArgs=ad;if(ad.elon_name){v(ad.elon_name)}if(ad.elon_name_arr){b(ad.elon_name_arr)}if(ad.elon_name_obj){L(ad.elon_name_obj)}if(ad.elon_alias_name_obj){i(ad.elon_alias_name_obj)}if(ad.elon_alias_name_arr){b(ad.elon_alias_name_arr)}};var a=function(ae){for(var ad=0;ad<ae.Item.length;ad++){C(ae.Item[ad])}};var w=function(ad){C(ad)};var C=function(ad){F(ad.UCPTname.get());if(g.argObj.requestDpCfgs){g.m_determineNumberOfLoggedDPs(ad);if(g.m_elonArgs&&g.m_elonArgs.elon_name_obj&&g.m_elonArgs.elon_name_obj.elon_point_arr){g.m_acceptUnknownDatasets=false;E(g.m_elonArgs.elon_name_obj.elon_point_arr)}else{E(ad)}}};this.m_determineNumberOfLoggedDPs=function(ad){g.m_numberOfLoggedDPs=0;var af=ad.DataPoint;if(af){for(var ae=0;ae<af.length;ae++){if(af[ae].dpType.get()=="Input"){g.m_numberOfLoggedDPs++}}}};var F=function(ad){g.r_loggerColl.Item.push(e.getItem({type:"Item",Item:ad,unmanaged:true}))};var K=function(ad){if(g.argObj.requestDpCfgs){e.getRemocalItem({xSelect:'//Item[@xsi:type="UFPTdataLogger_Cfg"]',type:"UFPTdataLogger_Cfg",Item:ad,callback:A});P++}else{F(ad)}};var A=function(af,ae,ad){P--;if(af){C(af)}};var E=function(ag){var ad;if(ag.r_proxy_type){var af=ag.DataPoint;if(af){ad=new Array();for(var ae=0;ae<af.length;ae++){if(af[ae].dpType.get()=="Input"){ad.push(af[ae].UCPTname.get())}}}}else{ad=ag}if(ad.length>0){e.Get({Item:ad,type:"Dp_Cfg",callback:J});o++}else{g.startReading()}};var J=function(ad){o--;if(ad!=null){g.handleAoDP_Config(ad.Item)}g.startReading()};var Q=function(ad){};var v=function(ad){g.r_loggerName=ad;K(ad)};var b=function(ad){for(var ae=0;ae<ad.length;ae++){K(ad[ae])}};var L=function(ad){v(ad.elon_name)};var i=function(ad){v(ad.elon_alias_name)};this.getMoreData=function(){g.f_maxPoints+=g.initialMaxPoints;g.newDataInRange();aa()};this.reset=function(){g.clearCallbacks();g.clearCache();o=0;P=0};var M=function(ad){if(ad==null){ad=true}if(c==ad){return}c=ad;var ae={type:q+"_Meta_Data",Item:g.r_loggerName,callback:r,xSelect:'//Item[@xsi:type="'+q+'_Meta_Data"]'+t};if(g.argObj.persistentPoll){ae.id="persistent"}if(g.argObj.pollMaxAge){ae.maxAge=g.argObj.pollMaxAge}e[ad?"poll":"stopPolling"](ae)};this.startReading=function(ad){if(o>0||P>0){return}if(ad){g.r_activeRangeStart=ad;g.f_cacheCleanup()}M(true);T(null,l)};this.stopReading=function(){if(o>0||P>0){return}M(false)};this.setActiveRangeStop=function(ad){if(ad){this.r_activeRangeStop=ad;this.m_explicitStop=true;this.f_isLiveLog=false;if(g.f_activeRangeCachedCompletely){M(false)}}else{this.m_explicitStop=false}};var g=this;this.argObj=W;var c;var d=false;var j=elon.elon;var u=elon.UtilObject.getInstance();var B=elon.ObjectArrayUtilities.getInstance();var e=W.sso;this.r_activeRangeStart=W.activeRangeStart;this.f_activeRangeCachedCompletely=false;this.r_loggerName=null;var ab;var h={};var y=null;var Y=false;var V=null;var S=64;var X=S;var l=S;var n=this.parentView.translate||function(ad){return ad};this.f_isLiveLog=true;var s=32;var D=null;var U=new Array();var Z=null;var f=true;var k=null;var R=null;var t=W.xSelect?W.xSelect:"";var q=W.fbType;var H=new Object();var N=new Object();this.metaData=null;this.xSelect="";this.r_loggerColl=e.getItem({type:"Item_Coll"});var o=0;var P=0;this.callbackRegistrationFunctions.push(g.onDensityChanged)};Echelon.LoggerCache.getInstance=function(a){return new Echelon.LoggerCache(a)};